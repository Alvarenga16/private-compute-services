<!--
 Copyright 2023 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

## Android Key Attestation

Android Key Attestation is a security feature that allows you to verify that a
cryptographic key was generated in a hardware-protected environment on an
Android device. This can be used to ensure that the key is not vulnerable to
attack (since it is not possible to extract a key) from malicious software
running on the device.

To use Key Attestation, you first need to generate a key pair in the Android
Keystore. The key pair must be generated in the Trusted Environment, which is a
secure hardware module that is isolated from the rest of the device.

While generating a keypair, you can request an attestation certificate from the
Android Keystore. The attestation certificate contains information about the key
pair, including the key identifier, the key algorithm, and the security level of
the Trusted Environment.

You can then send the attestation certificate to a server that you trust. The
server can use the attestation certificate to verify that the key pair was
generated in the Trusted Environment of a certified Android device and that the
key is not vulnerable to attack.

Here are the steps involved in key attestation:

1.  The app obtains a unique attestation challenge from the server (to prevent
    replay attack)
2.  The app requests a key pair (with attestation) from the Android Keystore.
3.  The Android Keystore generates the key pair and attestation cert in the
    Trusted Environment.
4.  The app extracts the attestation certificate from the Android Keystore.
5.  The app sends the attestation certificate to a trusted server.
6.  The trusted server verifies the attestation certificate and confirms that
    the key pair was generated in the Trusted Environment.

Private Compute Services makes use of key attestation to guarantee security
before performing sensitive operations, such as uploading aggregated metrics or
downloading sensitive models. A trusted Google server is used in validating
attestation records from Private Compute Services. This server makes use of the
https://github.com/google/android-key-attestation library, for validating the
records, and during the validation process, Private Compute Services does not
upload any PII or device identifier besides the unique key generated by the
device. No data is persisted by the Google servers for longer than the period
required to verify the attestation record.

For more information about key attestation, take a look at
https://developer.android.com/training/articles/security-key-attestation
